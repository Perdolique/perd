name: Build and Deploy
description: Build the project and deploy to the appropriate environment.

permissions:
  contents: read
  pull-requests: write

on:
  pull_request:
    branches:
      - master
    types:
      - opened
      - synchronize
  push:
    branches:
      - master

env:
  ARTIFACT_NAME: deployment-artifact
  ARTIFACT_PATH: .output

concurrency:
  group: build-and-deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Check Typescript types correctness
  test-typecheck:
    name: Typecheck
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
      - uses: ./.github/actions/setup-pnpm
        with:
          install-dependencies: true
      - name: Run typecheck
        run: |
          pnpm test:typecheck

  # Build the project and upload artifact
  build:
    name: Build artifact
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
      - uses: ./.github/actions/setup-pnpm
        with:
          install-dependencies: true
      - name: Build project
        run: |
          pnpm run build
      - name: Upload build artifact
        id: upload-artifact
        uses: actions/upload-artifact@v5
        with:
          include-hidden-files: true
          if-no-files-found: error
          name: ${{ env.ARTIFACT_NAME }}
          path: ${{ env.ARTIFACT_PATH }}

  deploy-to-staging:
    if: github.event_name == 'pull_request'
    name: Deploy to staging
    runs-on: ubuntu-24.04
    permissions:
      pull-requests: write
    outputs:
      wrangler-log: ${{ steps.set-wrangler-log.outputs.wrangler-log }}
    needs:
      - build
    steps:
      # Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v5

      # Setup, and download artifact
      - uses: ./.github/actions/pre-deploy
        with:
          artifact-name: ${{ env.ARTIFACT_NAME }}
          unpack-path: ${{ env.ARTIFACT_PATH }}

      # Set wrangler log file path for capturing output
      - name: Set wrangler output file path
        id: set-wrangler-log
        run: |
          WRANGLER_LOG=/tmp/wrangler-$(date '+%s%N').log
          echo "wrangler-log=$WRANGLER_LOG" >> $GITHUB_OUTPUT

      # Deploy to Cloudflare Workers
      - name: Deploy version to staging
        id: deploy-version
        continue-on-error: true
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          export WRANGLER_OUTPUT_FILE_PATH=${{ steps.set-wrangler-log.outputs.wrangler-log }}
          pnpm run deploy:versions:staging

      # Extract deployment URL from wrangler log
      - name: Get deployment URL
        id: get-deployment-url
        continue-on-error: true
        run: |
          PREVIEW_URL=$(jq --raw-output --slurp 'first(.[] | select(.preview_url) | .preview_url)' ${{ steps.set-wrangler-log.outputs.wrangler-log }})

          if [ -z "$PREVIEW_URL" ]; then
            echo "Error: No preview_url found in wrangler log"
            exit 1
          fi

          echo "preview-url=$PREVIEW_URL" >> $GITHUB_OUTPUT

      # Comment on the pull request with success status
      - name: Comment successful deployment URL
        if: ${{ steps.get-deployment-url.outcome == 'success' }}
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          message: |
            ## üéâ Deployed to Cloudflare!

            - Commit: `${{ github.sha }}`
            - Preview URL: ${{ steps.get-deployment-url.outputs.preview-url }}

      # Comment on the pull request with failure status
      - name: Comment deployment failure
        if: ${{ steps.get-deployment-url.outcome == 'failure' }}
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          message: |
            ## ‚ùå Deployment to Cloudflare failed!

            - Commit: `${{ github.sha }}`
            - Please check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for more details.

      # Fail the workflow if deployment failed
      - name: Fail workflow if deployment failed
        if: ${{ steps.get-deployment-url.outcome == 'failure' }}
        run: |
          echo "Deployment to staging failed."
          exit 1

  deploy-to-production:
    if: github.event_name == 'push'
    name: Deploy to production
    runs-on: ubuntu-24.04
    needs:
      - build
      - test-typecheck
    steps:
      # Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v5

      # Setup, and download artifact
      - uses: ./.github/actions/pre-deploy
        with:
          artifact-name: ${{ env.ARTIFACT_NAME }}
          unpack-path: ${{ env.ARTIFACT_PATH }}

      # Deploy to Cloudflare Workers
      - name: Deploy to production
        id: deploy-production
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          pnpm run deploy:production
